---
title: "Solicitudes de Acceso a la Información Pública 2015"
author: "Patricio del Boca"
date: "July 8, 2016"
output: html_document
---
```{r, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

## Introducción

La intención es jugar un poco con los datos publicados en el [Portal de Datos Abiertos de la Nacion](http://datos.gob.ar). Especificamente el dataset "Solicitudes de Acceso a la Información Pública 2015" mientras pruebo algunas modificaciones en el theme de ggplot inspirado por este post.

Algunas preguntas que se me vienen en mente son:

 - ¿Quiénes piden información?
 - ¿Sobre qué temas en particular?
 - ¿Qué tan eficiente fue el estado para respoder?
 - ¿Qué cantidad de solicitudes se generan?

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)
library(ggthemes)
```

```{r}
theme_Publication <- function(base_size=14, base_family="helvetica") {
      library(grid)
      library(ggthemes)
      (theme_foundation(base_size=base_size, base_family=base_family)
       + theme(plot.title = element_text(face = "bold",
                                         size = rel(1.2), hjust = 0.5),
               text = element_text(),
               panel.background = element_rect(colour = NA),
               plot.background = element_rect(colour = NA),
               panel.border = element_rect(colour = NA),
               axis.title = element_text(face = "bold",size = rel(1)),
               axis.title.y = element_blank(),
               axis.title.x = element_blank(),
               axis.text.y = element_blank(),
               axis.text.x = element_text(angle=30,
                                          vjust=1.35,
                                          hjust=1, 
                                          size=10), 
               axis.line = element_line(colour="black"),
               axis.ticks = element_blank(),
               panel.grid.major = element_blank(),
               panel.grid.minor = element_blank(),
               #legend.key = element_rect(colour = NA),
               #legend.position = "bottom",
               #legend.direction = "horizontal",
               #legend.key.size= unit(0.2, "cm"),
               #legend.margin = unit(0, "cm"),
               #legend.title = element_blank(),
               plot.margin=unit(c(10,5,5,5),"mm"),
               strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
               strip.text = element_text(face="bold")
          ))
      
}

scale_fill_Publication <- function(...){
      library(scales)
      discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}

scale_colour_Publication <- function(...){
      library(scales)
      discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)

}


theme_set(theme_Publication())
```



### Obtención de datos y Limpieza de Datos
```{r}
df <- read.csv("http://datos.gob.ar/dataset/8bc053c8-efc2-485d-97d3-915c476d2741/resource/63952097-cdba-4fdd-be84-65fb400bdb1a/download/acceso-informacion-publica.csv")

df$fecha_de_la_respuesta3 <- dmy(df$fecha_de_la_respuesta)

df$fecha_de_recepcion_de_la_solicitud_por_el_enlace <- dmy(
  df$fecha_de_recepcion_de_la_solicitud_por_el_enlace)

df$fecha_de_recepcion_de_la_solicitud_por_el_organismo <- dmy(
  df$fecha_de_recepcion_de_la_solicitud_por_el_organismo)

df$plazo_en_el_que_se_contesto_la_solicitud <- tolower(
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "en el plazo de 20 días",
  "10-20 días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "se contestó, pero luego de los 20 días",
  "20+ días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "30 días",
  "20+ días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "en el plazo de 10 días",
  "0-10 días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "en el plazo máximo de 20 días",
  "10-20 días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- gsub(
  "en el plazo máximo de 20 días",
  "10-20 días",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- ifelse(
  df$plazo_en_el_que_se_contesto_la_solicitud == "",
  "Pedientes/Derivadas/Devueltas",
  df$plazo_en_el_que_se_contesto_la_solicitud
)

df$plazo_en_el_que_se_contesto_la_solicitud <- factor(
  df$plazo_en_el_que_se_contesto_la_solicitud,
  levels=c("0-10 días","10-20 días", "20+ días", "aún no se contestó", "Pedientes/Derivadas/Devueltas")
)

df$perfil_del_solicitante <- tolower(df$perfil_del_solicitante)
df$perfil_del_solicitante <- as.factor(df$perfil_del_solicitante)
```

### Funciones Auxiliares
```{r}
tabla_contingencia <- function(data = df, column = column){
  tabla <- df %>%
      select_(column) %>% 
      group_by_(var = column) %>% 
      summarise(cantidad = n()) %>% 
      mutate(porcentaje = paste0(round(cantidad / sum(cantidad),3),"%"))
  tabla
}

grafico_barras_contingencia <- function(df, titulo){
g <- ggplot(data = df, aes(x=var, y=cantidad)) + 
  geom_bar(stat = "identity", fill="#004de6", width = 0.7) + 
  geom_text(aes(x=var,
                y=cantidad,
                label=paste0(cantidad, " (",porcentaje,")")),
                vjust=-0.4) +
  ggtitle(titulo)

g
}
```

#### ¿Qué tan eficiente fue el estado para respoder?
```{r, fig.height=7, fig.width=5}
tabla_estado <- tabla_contingencia(df, "estado")
p1 <- grafico_barras_contingencia(tabla_estado, "Tickets por Estado")
p1

# tabla_condicion <- tabla_contingencia(df, "condicion_de_respuesta")
# p2 <- grafico_barras_contingencia(tabla_condicion, 
#                                   "Respuestas a las solicitudes.") 
# p2

tabla_plazo <- tabla_contingencia(df, "plazo_en_el_que_se_contesto_la_solicitud")
p3 <- grafico_barras_contingencia(tabla_plazo, 
                                  "Plazo en las Respuestas")
p3
```

```{r}

```
